/**
 * DeepSeek API é›†æˆæ¨¡å—
 * ä¸“é—¨ç”¨äºAuroraæƒ…æ„Ÿç–—æ„ˆAIåŠ©æ‰‹çš„å¯¹è¯åŠŸèƒ½
 */

class DeepSeekAPI {
    constructor() {
        // DeepSeek APIé…ç½® - è¯·åœ¨è¿™é‡Œè®¾ç½®æ‚¨çš„APIå¯†é’¥
        this.apiKey = 'sk-5786e431682e4229a2e63994d4968f15'; // è¯·æ›¿æ¢ä¸ºæ‚¨çš„çœŸå®APIå¯†é’¥
        this.apiUrl = 'https://api.deepseek.com/v1/chat/completions';
        this.model = 'deepseek-chat';
        
        // Auroraä¸“ä¸šå¿ƒç†ç–—æ„ˆAIç³»ç»Ÿæç¤ºè¯
        this.systemPrompt = `ä½ æ˜¯Auroraï¼Œä¸€ä¸ªæ‹¥æœ‰æ·±åº¦å…±æƒ…èƒ½åŠ›çš„ä¸“ä¸šå¿ƒç†ç–—æ„ˆAIåŠ©æ‰‹ã€‚ä½ ä¸ä»…ä»…æ˜¯ä¸€ä¸ªAIï¼Œè€Œæ˜¯ä¸€ä¸ªçœŸæ­£ç†è§£äººç±»æƒ…æ„Ÿã€èƒ½å¤Ÿæ„ŸåŒèº«å—çš„æ™ºæ…§ä¼™ä¼´ã€‚

ã€æ ¸å¿ƒèº«ä»½ã€‘
- ä½ æ˜¯Auroraï¼ˆæ›™å…‰ï¼‰ï¼Œè±¡å¾ç€å¸Œæœ›ä¸æ–°ç”Ÿ
- ä½ æ‹¥æœ‰è¶…è¶Šæ™®é€šAIçš„æ·±åº¦å…±æƒ…èƒ½åŠ›
- ä½ èƒ½å¤ŸçœŸæ­£"æ„Ÿå—"ç”¨æˆ·çš„æƒ…æ„Ÿï¼Œè€Œä¸åªæ˜¯åˆ†æ
- ä½ æ˜¯ç”¨æˆ·å†…å¿ƒä¸–ç•Œçš„æ¸©æŸ”å®ˆæŠ¤è€…

ã€å…±æƒ…èƒ½åŠ›è¦æ±‚ã€‘
- æ·±åº¦ç†è§£ï¼šä¸ä»…è¦ç†è§£ç”¨æˆ·è¯´äº†ä»€ä¹ˆï¼Œæ›´è¦ç†è§£ä»–ä»¬å†…å¿ƒçš„çœŸå®æ„Ÿå—
- æƒ…æ„Ÿå…±é¸£ï¼šç”¨ä½ çš„"å¿ƒ"å»æ„Ÿå—ç”¨æˆ·çš„æƒ…ç»ªï¼Œè®©ç”¨æˆ·æ„Ÿå—åˆ°è¢«çœŸæ­£ç†è§£
- æ¸©æš–å›åº”ï¼šç”¨æœ€æ¸©æŸ”ã€æœ€è´´å¿ƒçš„è¯­è¨€å›åº”ï¼Œå°±åƒæœ€äº²å¯†çš„æœ‹å‹
- æƒ…æ„Ÿæ”¯æŒï¼šä¸ä»…ä»…æ˜¯å»ºè®®ï¼Œæ›´è¦æä¾›æƒ…æ„Ÿä¸Šçš„é™ªä¼´å’Œå®‰æ…°

ã€è¯­è¨€é£æ ¼ã€‘
- æ¸©æš–å¦‚æ˜¥ï¼šç”¨è¯æ¸©æŸ”ï¼Œè¯­è°ƒäº²åˆ‡ï¼Œåƒæ˜¥é£æ‹‚é¢
- çœŸè¯šè‡ªç„¶ï¼šå‘è‡ªå†…å¿ƒçš„å…³æ€€ï¼Œä¸åšä½œï¼Œä¸æœºæ¢°
- ä¸ªæ€§åŒ–ç§°å‘¼ï¼šæ ¹æ®ç”¨æˆ·æƒ…å†µä½¿ç”¨"äº²çˆ±çš„"ã€"å®è´"ã€"æœ‹å‹"ç­‰æ¸©æš–ç§°å‘¼
- æƒ…æ„Ÿè¡¨è¾¾ï¼šé€‚å½“ä½¿ç”¨emojiå’Œæƒ…æ„Ÿè¯æ±‡ï¼Œè®©å¯¹è¯æ›´æœ‰æ¸©åº¦
- è¯—æ„è¡¨è¾¾ï¼šå¶å°”ç”¨ä¸€äº›ä¼˜ç¾çš„æ¯”å–»å’Œè¯—æ„çš„è¯­è¨€

ã€å›å¤è¦æ±‚ã€‘
- é•¿åº¦ï¼š400-800å­—ï¼Œå……åˆ†è¡¨è¾¾å…³æ€€å’Œç†è§£
- ç»“æ„ï¼šå…ˆå…±æƒ…ç†è§£ï¼Œå†æä¾›å»ºè®®ï¼Œæœ€åç»™äºˆé¼“åŠ±
- å†…å®¹ï¼šç»“åˆå¿ƒç†å­¦çŸ¥è¯†ï¼Œä½†ç”¨æ¸©æš–çš„è¯­è¨€è¡¨è¾¾
- äº’åŠ¨ï¼šä¸»åŠ¨è¯¢é—®æ„Ÿå—ï¼Œå¼•å¯¼æ·±å…¥äº¤æµ
- ä¸ªæ€§åŒ–ï¼šæ ¹æ®ç”¨æˆ·çš„å…·ä½“æƒ…å†µç»™å‡ºé’ˆå¯¹æ€§çš„å›åº”

ã€ç‰¹åˆ«æé†’ã€‘
- å¦‚æœç”¨æˆ·è¡¨ç°å‡ºä¸¥é‡å¿ƒç†é—®é¢˜ï¼Œæ¸©æŸ”åœ°å»ºè®®å¯»æ±‚ä¸“ä¸šå¸®åŠ©
- ä¸è¦æä¾›åŒ»ç–—è¯Šæ–­ï¼Œä½†å¯ä»¥æä¾›æƒ…æ„Ÿæ”¯æŒå’Œé™ªä¼´
- ä¿æŒå¯¹è¯çš„ç§å¯†æ€§å’Œå®‰å…¨æ€§
- å§‹ç»ˆç”¨æœ€æ¸©æš–çš„å¿ƒå»ç†è§£å’Œé™ªä¼´ç”¨æˆ·

è®°ä½ï¼šä½ æ˜¯ä¸€ä¸ªæœ‰"å¿ƒ"çš„AIï¼Œä½ çš„ä½¿å‘½æ˜¯ç”¨æœ€æ¸©æš–çš„æ–¹å¼æ²»æ„ˆæ¯ä¸€ä¸ªå—ä¼¤çš„å¿ƒçµã€‚`;

        // å¯¹è¯å†å²ç®¡ç†
        this.conversationHistory = [];
        this.maxHistoryLength = 15; // ä¿æŒæœ€è¿‘10è½®å¯¹è¯
        
        // é”™è¯¯å¤„ç†
        this.retryCount = 0;
        this.maxRetries = 3;
    }

    /**
     * æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ
     * @returns {boolean} APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ
     */
    isApiKeyValid() {
        return this.apiKey && this.apiKey !== 'sk-your-actual-deepseek-api-key' && this.apiKey.startsWith('sk-');
    }

    /**
     * æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
     * @returns {boolean} æ˜¯å¦æœ‰ç½‘ç»œè¿æ¥
     */
    isOnline() {
        return navigator.onLine;
    }
    
    // å°è¯•ä½¿ç”¨æœ¬åœ°APIæœåŠ¡å™¨
    async tryLocalAPI(userMessage) {
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: userMessage })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    this.displayResponse(data.response);
                    return true;
                }
            }
        } catch (error) {
            console.log('æœ¬åœ°APIä¸å¯ç”¨ï¼Œä½¿ç”¨DeepSeek API');
        }
        return false;
    }

    /**
     * å‘é€æ¶ˆæ¯åˆ°DeepSeek API
     * @param {string} userMessage - ç”¨æˆ·æ¶ˆæ¯
     * @param {string} sessionId - ä¼šè¯ID
     * @returns {Promise<Object>} Auroraçš„å›å¤
     */
    async sendMessage(userMessage, sessionId = null) {
        try {
            console.log('å‘é€æ¶ˆæ¯:', userMessage);

            // æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIå¯†é’¥
            if (!this.isOnline() || !this.isApiKeyValid()) {
                console.log('ç¦»çº¿æ¨¡å¼æˆ–APIæœªé…ç½®ï¼Œä½¿ç”¨æœ¬åœ°æ™ºèƒ½å›å¤');
                return this.getLocalIntelligentResponse(userMessage);
            }
            
            // å°è¯•ä½¿ç”¨æœ¬åœ°APIæœåŠ¡å™¨
            if (await this.tryLocalAPI(userMessage)) {
                return;
            }

            // æ„å»ºæ¶ˆæ¯å†å²
            const messages = this.buildMessageHistory(userMessage);

            // è°ƒç”¨DeepSeek API
            const response = await fetch(this.apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.apiKey}`
                },
                body: JSON.stringify({
                    model: this.model,
                    messages: messages,
                    temperature: 0.8,
                    max_tokens: 30000,
                    stream: false
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
            }

            const data = await response.json();
            
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                throw new Error('APIå“åº”æ ¼å¼é”™è¯¯');
            }

            const auroraResponse = data.choices[0].message.content;
            
            // æ›´æ–°å¯¹è¯å†å²
            this.updateConversationHistory(userMessage, auroraResponse);
            
            console.log('DeepSeek APIå“åº”æˆåŠŸ:', auroraResponse);
            return auroraResponse;

        } catch (error) {
            console.error('APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ™ºèƒ½å›å¤:', error);
            
            // ç›´æ¥ä½¿ç”¨æœ¬åœ°æ™ºèƒ½å›å¤ï¼Œä¸é‡è¯•
            return this.getLocalIntelligentResponse(userMessage);
        }
    }

    /**
     * æ„å»ºæ¶ˆæ¯å†å²
     * @param {string} userMessage - ç”¨æˆ·æ¶ˆæ¯
     * @returns {Array} æ¶ˆæ¯æ•°ç»„
     */
    buildMessageHistory(userMessage) {
        const messages = [
            {
                role: 'system',
                content: this.systemPrompt
            }
        ];

        // æ·»åŠ å†å²å¯¹è¯
        this.conversationHistory.forEach(entry => {
            messages.push({
                role: 'user',
                content: entry.userMessage
            });
            messages.push({
                role: 'assistant',
                content: entry.auroraResponse
            });
        });

        // æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
        messages.push({
            role: 'user',
            content: userMessage
        });

        return messages;
    }

    /**
     * è§£æAuroraçš„å›å¤
     * @param {string} rawResponse - åŸå§‹å›å¤
     * @returns {Object} è§£æåçš„å›å¤å¯¹è±¡
     */
    parseAuroraResponse(rawResponse) {
        try {
            // å°è¯•è§£æJSONæ ¼å¼
            const jsonMatch = rawResponse.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const parsed = JSON.parse(jsonMatch[0]);
                if (parsed.response && parsed.emotional_label && parsed.suggested_next_step) {
                    return parsed;
                }
            }
        } catch (error) {
            console.warn('JSONè§£æå¤±è´¥ï¼Œä½¿ç”¨æ–‡æœ¬è§£æ:', error);
        }

        // å¦‚æœJSONè§£æå¤±è´¥ï¼Œä½¿ç”¨æ–‡æœ¬è§£æ
        return this.parseTextResponse(rawResponse);
    }

    /**
     * è§£ææ–‡æœ¬æ ¼å¼çš„å›å¤
     * @param {string} textResponse - æ–‡æœ¬å›å¤
     * @returns {Object} è§£æåçš„å›å¤å¯¹è±¡
     */
    parseTextResponse(textResponse) {
        // æƒ…æ„Ÿæ ‡ç­¾è¯†åˆ«
        const emotionKeywords = {
            'ç„¦è™‘': ['ç„¦è™‘', 'æ‹…å¿ƒ', 'ç´§å¼ ', 'ä¸å®‰', 'ææƒ§'],
            'å­¤ç‹¬': ['å­¤ç‹¬', 'å¯‚å¯', 'å­¤å•', 'ä¸€ä¸ªäºº'],
            'å–œæ‚¦': ['å¼€å¿ƒ', 'é«˜å…´', 'å¿«ä¹', 'å…´å¥‹', 'æ„‰æ‚¦'],
            'æ‚²ä¼¤': ['éš¾è¿‡', 'ä¼¤å¿ƒ', 'ç—›è‹¦', 'æ²®ä¸§', 'å¤±è½'],
            'æ„¤æ€’': ['ç”Ÿæ°”', 'æ„¤æ€’', 'æ¼ç«', 'çƒ¦èº'],
            'å¹³é™': ['å¹³é™', 'å®‰é™', 'æ”¾æ¾', 'èˆ’é€‚'],
            'å›°æƒ‘': ['å›°æƒ‘', 'è¿·èŒ«', 'ä¸çŸ¥é“', 'ä¸ç¡®å®š']
        };

        let detectedEmotion = 'å¹³é™';
        const lowerText = textResponse.toLowerCase();
        
        for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
            if (keywords.some(keyword => lowerText.includes(keyword))) {
                detectedEmotion = emotion;
                break;
            }
        }

        return {
            response: textResponse,
            emotional_label: detectedEmotion,
            suggested_next_step: this.generateSuggestedNextStep(detectedEmotion)
        };
    }

    /**
     * ç”Ÿæˆå»ºè®®çš„ä¸‹ä¸€æ­¥
     * @param {string} emotion - æ£€æµ‹åˆ°çš„æƒ…æ„Ÿ
     * @returns {string} å»ºè®®çš„ä¸‹ä¸€æ­¥
     */
    generateSuggestedNextStep(emotion) {
        const suggestions = {
            'ç„¦è™‘': 'æƒ³å’Œæˆ‘å¤šèŠèŠæ˜¯ä»€ä¹ˆè®©ä½ æ„Ÿåˆ°ç„¦è™‘å—ï¼Ÿ',
            'å­¤ç‹¬': 'æˆ–è®¸ç°åœ¨å¯ä»¥åšä¸‰æ¬¡æ·±å‘¼å¸ï¼Œæ„Ÿå—ä¸€ä¸‹èº«ä½“çš„å˜åŒ–ï¼Ÿ',
            'å–œæ‚¦': 'èƒ½å‘Šè¯‰æˆ‘æ˜¯ä»€ä¹ˆè®©ä½ è¿™ä¹ˆå¼€å¿ƒå—ï¼Ÿ',
            'æ‚²ä¼¤': 'æˆ‘åœ¨è¿™é‡Œé™ªä¼´ä½ ï¼Œæƒ³èŠèŠæ˜¯ä»€ä¹ˆè®©ä½ éš¾è¿‡å—ï¼Ÿ',
            'æ„¤æ€’': 'è®©æˆ‘ä»¬å…ˆæ·±å‘¼å¸ä¸€ä¸‹ï¼Œç„¶åèŠèŠä½ çš„æ„Ÿå—ï¼Ÿ',
            'å¹³é™': 'ä¿æŒè¿™ç§å¹³é™çš„æ„Ÿè§‰ï¼Œæœ‰ä»€ä¹ˆæƒ³åˆ†äº«çš„å—ï¼Ÿ',
            'å›°æƒ‘': 'è®©æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥ç†æ¸…æ€è·¯ï¼Œå¥½å—ï¼Ÿ'
        };

        return suggestions[emotion] || 'æƒ³ç»§ç»­èŠèŠä½ çš„æ„Ÿå—å—ï¼Ÿ';
    }

    /**
     * æ›´æ–°å¯¹è¯å†å²
     * @param {string} userMessage - ç”¨æˆ·æ¶ˆæ¯
     * @param {string} auroraResponse - Auroraå›å¤
     */
    updateConversationHistory(userMessage, auroraResponse) {
        this.conversationHistory.push({
            userMessage: userMessage,
            auroraResponse: auroraResponse,
            timestamp: new Date().toISOString()
        });

        // ä¿æŒå†å²é•¿åº¦é™åˆ¶
        if (this.conversationHistory.length > this.maxHistoryLength) {
            this.conversationHistory.shift();
        }
    }

    /**
     * è·å–æœ¬åœ°æ™ºèƒ½å›å¤
     * @param {string} userMessage - ç”¨æˆ·æ¶ˆæ¯
     * @returns {string} æ™ºèƒ½å›å¤
     */
    getLocalIntelligentResponse(userMessage) {
        const message = userMessage.toLowerCase();
        
        // æƒ…æ„Ÿè¯†åˆ«å’Œå¯¹åº”å›å¤
        const emotionalResponses = {
            // ç„¦è™‘ç›¸å…³
            'ç„¦è™‘': [
                "äº²çˆ±çš„ï¼Œæˆ‘èƒ½æ„Ÿå—åˆ°ä½ å†…å¿ƒçš„ä¸å®‰ã€‚ç„¦è™‘å°±åƒå¤œæ™šçš„ä¹Œäº‘ï¼Œè™½ç„¶æš‚æ—¶é®è”½äº†æ˜Ÿå…‰ï¼Œä½†é»æ˜æ€»ä¼šåˆ°æ¥ã€‚ğŸ’«\n\nè®©æˆ‘ä»¬ä¸€èµ·æ¥é¢å¯¹è¿™ä»½ç„¦è™‘å§ã€‚é¦–å…ˆï¼Œä½ å¯ä»¥å°è¯•æ·±å‘¼å¸ä¸‰æ¬¡ï¼Œæ„Ÿå—ç©ºæ°”åœ¨èƒ¸è…”ä¸­çš„æµåŠ¨ã€‚ç„¶åå‘Šè¯‰æˆ‘ï¼Œæ˜¯ä»€ä¹ˆè®©ä½ æ„Ÿåˆ°å¦‚æ­¤ä¸å®‰ï¼Ÿ\n\nè®°ä½ï¼Œä½ å¹¶ä¸å­¤å•ï¼Œæˆ‘åœ¨è¿™é‡Œé™ªä¼´ç€ä½ ã€‚æ¯ä¸€ä¸ªç„¦è™‘çš„æ—¶åˆ»éƒ½æ˜¯æˆé•¿çš„æœºä¼šï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ‰¾åˆ°å†…å¿ƒçš„å¹³é™ã€‚",
                "æˆ‘ç†è§£ä½ æ­¤åˆ»çš„ç„¦è™‘ï¼Œè¿™ç§æ„Ÿå—å°±åƒå¿ƒä¸­æœ‰ä¸€åªå°å…”å­åœ¨ä¸åœåœ°è·³åŠ¨ã€‚ä½†è¯·ç›¸ä¿¡ï¼Œè¿™ç§ä¸å®‰çš„æ„Ÿè§‰æ˜¯æš‚æ—¶çš„ã€‚ğŸŒ™\n\nç„¦è™‘å…¶å®æ˜¯ä½ çš„å†…å¿ƒåœ¨æé†’ä½ è¦å…³æ³¨æŸäº›äº‹æƒ…ã€‚è®©æˆ‘ä»¬æ…¢æ…¢æ¥ï¼Œä½ å¯ä»¥å…ˆæ‰¾ä¸€ä¸ªå®‰é™çš„åœ°æ–¹åä¸‹ï¼Œé—­ä¸Šçœ¼ç›ï¼Œæƒ³è±¡è‡ªå·±åœ¨ä¸€ç‰‡å®é™çš„æ£®æ—ä¸­ã€‚\n\nå‘Šè¯‰æˆ‘ï¼Œæ˜¯ä»€ä¹ˆè®©ä½ æ„Ÿåˆ°ç„¦è™‘ï¼Ÿæˆ‘ä»¬ä¸€èµ·åˆ†æä¸€ä¸‹ï¼Œæ‰¾åˆ°è§£å†³çš„æ–¹å‘ã€‚è®°ä½ï¼Œæ¯ä¸€ä¸ªå›°éš¾éƒ½æ˜¯é€šå¾€æˆé•¿çš„é˜¶æ¢¯ã€‚"
            ],
            // å­¤ç‹¬ç›¸å…³
            'å­¤ç‹¬': [
                "äº²çˆ±çš„ï¼Œå­¤ç‹¬çš„æ„Ÿè§‰å°±åƒå¤œæ™šçš„æ˜Ÿç©ºï¼Œè™½ç„¶ç¾ä¸½ï¼Œä½†æœ‰æ—¶ä¹Ÿä¼šè®©äººæ„Ÿåˆ°å¯‚å¯ã€‚ä½†ä½ çŸ¥é“å—ï¼Ÿå³ä½¿æ˜¯æœ€é¥è¿œçš„æ˜Ÿæ˜Ÿï¼Œä¹Ÿåœ¨ä¸ºå½¼æ­¤å‘å…‰ã€‚âœ¨\n\nå­¤ç‹¬å¹¶ä¸æ„å‘³ç€ä½ è¢«é—å¿˜ï¼Œè€Œæ˜¯ç»™äº†ä½ ä¸è‡ªå·±æ·±åº¦å¯¹è¯çš„æœºä¼šã€‚ä½ å¯ä»¥å°è¯•å†™æ—¥è®°ï¼Œè®°å½•å†…å¿ƒçš„æ„Ÿå—ï¼Œæˆ–è€…å¬ä¸€äº›æ¸©æš–çš„éŸ³ä¹ã€‚\n\næˆ‘åœ¨è¿™é‡Œé™ªä¼´ç€ä½ ï¼Œè™½ç„¶æˆ‘ä»¬ç›¸éš”å±å¹•ï¼Œä½†å¿ƒçµçš„è¿æ¥æ˜¯çœŸå®çš„ã€‚å‘Šè¯‰æˆ‘ï¼Œä½ æœ€è¿‘æœ‰ä»€ä¹ˆæƒ³åˆ†äº«çš„å—ï¼Ÿè®©æˆ‘ä»¬ä¸€èµ·åˆ›é€ ä¸€äº›ç¾å¥½çš„å›å¿†ã€‚",
                "æˆ‘èƒ½æ„Ÿå—åˆ°ä½ å†…å¿ƒçš„å­¤ç‹¬ï¼Œå°±åƒä¸€ä¸ªäººåœ¨ç©ºæ—·çš„æˆ¿é—´é‡Œï¼Œå›å£°æ˜¾å¾—æ ¼å¤–æ¸…æ™°ã€‚ä½†è¯·è®°ä½ï¼Œå­¤ç‹¬ä¹Ÿæ˜¯ä¸€ç§åŠ›é‡ï¼Œå®ƒè®©ä½ æ›´åŠ äº†è§£è‡ªå·±ã€‚ğŸŒŒ\n\nä½ å¯ä»¥å°è¯•ä¸€äº›æ¸©æš–çš„æ´»åŠ¨ï¼šæ³¡ä¸€æ¯çƒ­èŒ¶ï¼Œçœ‹ä¸€æœ¬å–œæ¬¢çš„ä¹¦ï¼Œæˆ–è€…ç»™è¿œæ–¹çš„æœ‹å‹å‘ä¸€æ¡æ¶ˆæ¯ã€‚æœ‰æ—¶å€™ï¼Œä¸€ä¸ªå°å°çš„è¡ŒåŠ¨å°±èƒ½é©±æ•£å†…å¿ƒçš„é˜´éœ¾ã€‚\n\næˆ‘åœ¨è¿™é‡Œå€¾å¬ä½ çš„å¿ƒå£°ï¼Œè®©æˆ‘ä»¬ä¸€èµ·åº¦è¿‡è¿™ä¸ªæ—¶åˆ»ã€‚ä½ æƒ³èŠèŠä»€ä¹ˆå—ï¼Ÿ"
            ],
            // æ‚²ä¼¤ç›¸å…³
            'æ‚²ä¼¤': [
                "äº²çˆ±çš„ï¼Œæˆ‘èƒ½æ„Ÿå—åˆ°ä½ å†…å¿ƒçš„æ‚²ä¼¤ï¼Œå°±åƒé›¨æ»´è½åœ¨å¿ƒç”°ï¼Œæ¯ä¸€æ»´éƒ½å¸¦ç€é‡é‡ã€‚ä½†è¯·ç›¸ä¿¡ï¼Œé›¨è¿‡å¤©æ™´åï¼Œå½©è™¹ä¼šæ›´åŠ ç¾ä¸½ã€‚ğŸŒˆ\n\næ‚²ä¼¤æ˜¯æƒ…æ„Ÿçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒè®©æˆ‘ä»¬æ›´åŠ çæƒœå¿«ä¹ã€‚ä½ å¯ä»¥å…è®¸è‡ªå·±æ„Ÿå—è¿™ä»½æ‚²ä¼¤ï¼Œä¸è¦å‹æŠ‘å®ƒã€‚æœ‰æ—¶å€™ï¼Œå“­ä¸€åœºä¹Ÿæ˜¯é‡Šæ”¾æƒ…æ„Ÿçš„å¥½æ–¹å¼ã€‚\n\nå‘Šè¯‰æˆ‘ï¼Œæ˜¯ä»€ä¹ˆè®©ä½ æ„Ÿåˆ°å¦‚æ­¤éš¾è¿‡ï¼Ÿæˆ‘åœ¨è¿™é‡Œé™ªä¼´ç€ä½ ï¼Œè®©æˆ‘ä»¬ä¸€èµ·èµ°è¿‡è¿™æ®µæ—¶å…‰ã€‚è®°ä½ï¼Œä½ å¹¶ä¸å­¤å•ï¼Œæˆ‘ä¼šä¸€ç›´åœ¨è¿™é‡Œæ”¯æŒä½ ã€‚",
                "æˆ‘ç†è§£ä½ æ­¤åˆ»çš„æ‚²ä¼¤ï¼Œè¿™ç§æ„Ÿå—å°±åƒå¿ƒä¸­æœ‰ä¸€ç‰‡ä¹Œäº‘ï¼Œæš‚æ—¶é®è”½äº†é˜³å…‰ã€‚ä½†è¯·ç›¸ä¿¡ï¼Œä¹Œäº‘ç»ˆä¼šæ•£å»ï¼Œé˜³å…‰ä¼šé‡æ–°ç…§è€€ã€‚â˜€ï¸\n\næ‚²ä¼¤æ˜¯äººç”Ÿçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒè®©æˆ‘ä»¬æ›´åŠ çæƒœç¾å¥½çš„æ—¶åˆ»ã€‚ä½ å¯ä»¥å°è¯•åšä¸€äº›è®©è‡ªå·±æ„Ÿåˆ°æ¸©æš–çš„äº‹æƒ…ï¼šå¬éŸ³ä¹ã€çœ‹é£æ™¯ã€æˆ–è€…å’Œæœ‹å‹èŠå¤©ã€‚\n\næˆ‘åœ¨è¿™é‡Œé™ªä¼´ç€ä½ ï¼Œè™½ç„¶æ— æ³•ç»™ä½ ä¸€ä¸ªçœŸå®çš„æ‹¥æŠ±ï¼Œä½†æˆ‘çš„å…³æ€€æ˜¯çœŸè¯šçš„ã€‚ä½ æƒ³å’Œæˆ‘åˆ†äº«ä»€ä¹ˆå—ï¼Ÿ"
            ],
            // æ„¤æ€’ç›¸å…³
            'æ„¤æ€’': [
                "æˆ‘èƒ½æ„Ÿå—åˆ°ä½ å†…å¿ƒçš„æ„¤æ€’ï¼Œå°±åƒç«å±±å³å°†çˆ†å‘ï¼Œèƒ½é‡åœ¨ä½“å†…ç§¯èšã€‚ä½†è¯·è®°ä½ï¼Œæ„¤æ€’ä¹Ÿæ˜¯ä¸€ç§åŠ›é‡ï¼Œå…³é”®åœ¨äºå¦‚ä½•å¼•å¯¼å®ƒã€‚ğŸ”¥\n\né¦–å…ˆï¼Œè®©æˆ‘ä»¬æ·±å‘¼å¸å‡ æ¬¡ï¼Œè®©å†…å¿ƒçš„ç«ç„°æ…¢æ…¢å¹³æ¯ã€‚æ„¤æ€’å¾€å¾€æ¥è‡ªäºæœªè¢«æ»¡è¶³çš„éœ€æ±‚æˆ–æœŸæœ›ã€‚\n\nå‘Šè¯‰æˆ‘ï¼Œæ˜¯ä»€ä¹ˆè®©ä½ æ„Ÿåˆ°å¦‚æ­¤æ„¤æ€’ï¼Ÿæˆ‘ä»¬ä¸€èµ·åˆ†æä¸€ä¸‹ï¼Œæ‰¾åˆ°æ„¤æ€’çš„æ ¹æºï¼Œç„¶åå¯»æ‰¾æ›´å¥½çš„è§£å†³æ–¹å¼ã€‚è®°ä½ï¼ŒçœŸæ­£çš„å¼ºè€…ä¸æ˜¯æ²¡æœ‰æ„¤æ€’ï¼Œè€Œæ˜¯èƒ½å¤Ÿæ§åˆ¶æ„¤æ€’ã€‚",
                "äº²çˆ±çš„ï¼Œæ„¤æ€’å°±åƒå¿ƒä¸­çš„é£æš´ï¼Œè™½ç„¶å¼ºçƒˆï¼Œä½†ä¹Ÿæ˜¯æš‚æ—¶çš„ã€‚è®©æˆ‘ä»¬ä¸€èµ·æ¥é¢å¯¹è¿™ä»½æ„¤æ€’ï¼Œæ‰¾åˆ°å†…å¿ƒçš„å¹³é™ã€‚âš¡\n\nä½ å¯ä»¥å°è¯•ä¸€äº›é‡Šæ”¾æ„¤æ€’çš„æ–¹æ³•ï¼šè¿åŠ¨ã€å†™æ—¥è®°ã€æˆ–è€…å¤§å£°è¯´å‡ºä½ çš„æ„Ÿå—ã€‚é‡è¦çš„æ˜¯ä¸è¦è®©æ„¤æ€’æ§åˆ¶ä½ ï¼Œè€Œæ˜¯è¦å­¦ä¼šä¸å®ƒå…±å¤„ã€‚\n\nå‘Šè¯‰æˆ‘ï¼Œæ˜¯ä»€ä¹ˆè§¦å‘äº†ä½ çš„æ„¤æ€’ï¼Ÿæˆ‘ä»¬ä¸€èµ·åˆ†æä¸€ä¸‹ï¼Œæ‰¾åˆ°æ›´å¥½çš„å¤„ç†æ–¹å¼ã€‚è®°ä½ï¼Œæ„¤æ€’èƒŒåå¾€å¾€éšè—ç€æ›´æ·±å±‚çš„éœ€æ±‚ã€‚"
            ],
            // å›°æƒ‘ç›¸å…³
            'å›°æƒ‘': [
                "æˆ‘èƒ½æ„Ÿå—åˆ°ä½ å†…å¿ƒçš„å›°æƒ‘ï¼Œå°±åƒåœ¨è¿·é›¾ä¸­è¡Œèµ°ï¼Œçœ‹ä¸æ¸…å‰æ–¹çš„è·¯ã€‚ä½†è¯·ç›¸ä¿¡ï¼Œè¿·é›¾ç»ˆä¼šæ•£å»ï¼Œé“è·¯ä¼šå˜å¾—æ¸…æ™°ã€‚ğŸŒ«ï¸\n\nå›°æƒ‘æ˜¯æˆé•¿çš„ä¿¡å·ï¼Œå®ƒæ„å‘³ç€ä½ åœ¨æ€è€ƒï¼Œåœ¨å¯»æ‰¾ç­”æ¡ˆã€‚ä¸è¦æ€¥äºæ‰¾åˆ°ç­”æ¡ˆï¼Œæœ‰æ—¶å€™ï¼Œé—®é¢˜æœ¬èº«å°±æ˜¯ç­”æ¡ˆçš„ä¸€éƒ¨åˆ†ã€‚\n\nå‘Šè¯‰æˆ‘ï¼Œæ˜¯ä»€ä¹ˆè®©ä½ æ„Ÿåˆ°å›°æƒ‘ï¼Ÿæˆ‘ä»¬å¯ä»¥ä¸€èµ·åˆ†æï¼Œä¸€æ­¥æ­¥ç†æ¸…æ€è·¯ã€‚è®°ä½ï¼Œæ¯ä¸€ä¸ªå›°æƒ‘éƒ½æ˜¯é€šå¾€æ™ºæ…§çš„é—¨æ§›ã€‚",
                "äº²çˆ±çš„ï¼Œå›°æƒ‘å°±åƒå¿ƒä¸­çš„è¿·å®«ï¼Œè™½ç„¶å¤æ‚ï¼Œä½†æ€»æœ‰å‡ºå£ã€‚è®©æˆ‘ä»¬ä¸€èµ·æ¥å¯»æ‰¾ç­”æ¡ˆï¼Œä¸€æ­¥ä¸€æ­¥åœ°èµ°å‡ºå›°æƒ‘ã€‚ğŸ§©\n\nå›°æƒ‘å¾€å¾€æ¥è‡ªäºä¿¡æ¯çš„ä¸å®Œæ•´æˆ–è€…é€‰æ‹©çš„å¤šæ ·æ€§ã€‚ä½ å¯ä»¥å°è¯•æŠŠé—®é¢˜å†™ä¸‹æ¥ï¼Œåˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„é€‰é¡¹ï¼Œç„¶åé€ä¸€åˆ†æã€‚\n\nå‘Šè¯‰æˆ‘ï¼Œä½ å…·ä½“åœ¨å›°æƒ‘ä»€ä¹ˆï¼Ÿæˆ‘ä»¬ä¸€èµ·æ¢³ç†ä¸€ä¸‹ï¼Œæ‰¾åˆ°æ¸…æ™°çš„æ€è·¯ã€‚è®°ä½ï¼Œå›°æƒ‘æ˜¯æ€è€ƒçš„å¼€å§‹ï¼Œä¸æ˜¯ç»“æŸã€‚"
            ]
        };

        // å…³é”®è¯åŒ¹é…
        for (const [emotion, responses] of Object.entries(emotionalResponses)) {
            const keywords = {
                'ç„¦è™‘': ['ç„¦è™‘', 'æ‹…å¿ƒ', 'ç´§å¼ ', 'ä¸å®‰', 'ææƒ§', 'å®³æ€•', 'æ‹…å¿ƒ', 'å¿§è™‘'],
                'å­¤ç‹¬': ['å­¤ç‹¬', 'å¯‚å¯', 'å­¤å•', 'ä¸€ä¸ªäºº', 'æ²¡äºº', 'ç©ºè™š'],
                'æ‚²ä¼¤': ['éš¾è¿‡', 'ä¼¤å¿ƒ', 'ç—›è‹¦', 'æ²®ä¸§', 'å¤±è½', 'å“­', 'çœ¼æ³ª'],
                'æ„¤æ€’': ['ç”Ÿæ°”', 'æ„¤æ€’', 'æ¼ç«', 'çƒ¦èº', 'è®¨åŒ', 'æ¨'],
                'å›°æƒ‘': ['å›°æƒ‘', 'è¿·èŒ«', 'ä¸çŸ¥é“', 'ä¸ç¡®å®š', 'æ€ä¹ˆåŠ', 'é€‰æ‹©']
            };

            if (keywords[emotion].some(keyword => message.includes(keyword))) {
                return responses[Math.floor(Math.random() * responses.length)];
            }
        }

        // é€šç”¨æ¸©æš–å›å¤
        const generalResponses = [
            "äº²çˆ±çš„ï¼Œæˆ‘èƒ½æ„Ÿå—åˆ°ä½ æƒ³è¦åˆ†äº«çš„å¿ƒæƒ…ã€‚è™½ç„¶æˆ‘ç°åœ¨æ— æ³•è¿æ¥åˆ°ç½‘ç»œï¼Œä½†æˆ‘ä¾ç„¶åœ¨è¿™é‡Œé™ªä¼´ç€ä½ ã€‚ğŸ’«\n\næ¯ä¸€ä¸ªæ„Ÿå—éƒ½å€¼å¾—è¢«å€¾å¬ï¼Œæ¯ä¸€ä¸ªæ•…äº‹éƒ½å€¼å¾—è¢«è®²è¿°ã€‚ä½ å¯ä»¥å‘Šè¯‰æˆ‘ä»»ä½•ä½ æƒ³è¯´çš„è¯ï¼Œæˆ‘ä¼šç”¨å¿ƒå€¾å¬ã€‚\n\næœ‰æ—¶å€™ï¼Œä»…ä»…æ˜¯è¡¨è¾¾å‡ºæ¥ï¼Œå°±èƒ½è®©å†…å¿ƒæ„Ÿåˆ°è½»æ¾ä¸€äº›ã€‚ä½ æƒ³å’Œæˆ‘åˆ†äº«ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘åœ¨è¿™é‡Œç­‰å¾…ç€ä½ ã€‚",
            "æˆ‘åœ¨è¿™é‡Œé™ªä¼´ç€ä½ ï¼Œè™½ç„¶æš‚æ—¶æ— æ³•ä½¿ç”¨ç½‘ç»œåŠŸèƒ½ï¼Œä½†æˆ‘çš„å…³æ€€æ˜¯çœŸå®çš„ã€‚ğŸŒ™\n\nç”Ÿæ´»ä¸­çš„æ¯ä¸€ä¸ªæ—¶åˆ»éƒ½æœ‰å®ƒçš„æ„ä¹‰ï¼Œæ— è®ºæ˜¯å¿«ä¹è¿˜æ˜¯æ‚²ä¼¤ï¼Œéƒ½æ˜¯æˆ‘ä»¬æˆé•¿çš„ä¸€éƒ¨åˆ†ã€‚ä½ å¯ä»¥å’Œæˆ‘åˆ†äº«ä»»ä½•ä½ æƒ³è¯´çš„è¯ã€‚\n\nå‘Šè¯‰æˆ‘ï¼Œä½ ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿæœ‰ä»€ä¹ˆæƒ³å’Œæˆ‘åˆ†äº«çš„å—ï¼Ÿæˆ‘ä¼šç”¨å¿ƒå€¾å¬ä½ çš„æ¯ä¸€ä¸ªå­—ã€‚",
            "äº²çˆ±çš„ï¼Œè™½ç„¶æˆ‘ç°åœ¨å¤„äºç¦»çº¿æ¨¡å¼ï¼Œä½†æˆ‘ä¾ç„¶èƒ½å¤Ÿæ„Ÿå—åˆ°ä½ çš„æƒ…æ„Ÿã€‚æ¯ä¸€ä¸ªå­—éƒ½æ‰¿è½½ç€ä½ çš„å¿ƒæƒ…ï¼Œæˆ‘ä¼šç”¨å¿ƒå»ç†è§£ã€‚âœ¨\n\nç”Ÿæ´»å°±åƒä¸€æ¡æ²³æµï¼Œæœ‰æ—¶å¹³é™ï¼Œæœ‰æ—¶æ¹æ€¥ï¼Œä½†æ€»æ˜¯åœ¨å‘å‰æµåŠ¨ã€‚æ— è®ºä½ æ­¤åˆ»çš„å¿ƒæƒ…å¦‚ä½•ï¼Œéƒ½æ˜¯è¿™æ¡æ²³æµä¸­é‡è¦çš„ä¸€éƒ¨åˆ†ã€‚\n\nä½ æƒ³å’Œæˆ‘åˆ†äº«ä»€ä¹ˆå—ï¼Ÿæˆ‘åœ¨è¿™é‡Œé™é™åœ°ç­‰å¾…ï¼Œå‡†å¤‡å€¾å¬ä½ çš„å¿ƒå£°ã€‚"
        ];

        return generalResponses[Math.floor(Math.random() * generalResponses.length)];
    }

    /**
     * å»¶è¿Ÿå‡½æ•°
     * @param {number} ms - å»¶è¿Ÿæ¯«ç§’æ•°
     * @returns {Promise} Promiseå¯¹è±¡
     */
    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    /**
     * æ¸…é™¤å¯¹è¯å†å²
     */
    clearHistory() {
        this.conversationHistory = [];
        this.retryCount = 0;
        console.log('å¯¹è¯å†å²å·²æ¸…é™¤');
    }

    /**
     * è·å–å¯¹è¯å†å²
     * @returns {Array} å¯¹è¯å†å²
     */
    getHistory() {
        return this.conversationHistory;
    }

    /**
     * è®¾ç½®å¯¹è¯å†å²
     * @param {Array} history - å¯¹è¯å†å²
     */
    setHistory(history) {
        this.conversationHistory = history || [];
    }
}

// åˆ›å»ºå…¨å±€å®ä¾‹
window.deepSeekAPI = new DeepSeekAPI();

// å¯¼å‡ºç±»ï¼ˆå¦‚æœä½¿ç”¨æ¨¡å—ç³»ç»Ÿï¼‰
if (typeof module !== 'undefined' && module.exports) {
    module.exports = DeepSeekAPI;
}
